name: XSOAR CI/CD
on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.ref_name }}
      DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
      DEMISTO_README_VALIDATION: "false"
      BEFORE_SHA: ${{ github.event.before }}
      GITHUB_SHA: ${{ github.sha }}

    steps:
      - name: XSOAR CI/CD master checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Content checkout
        uses: actions/checkout@v4
        with:
          repository: demisto/content
          path: content
          fetch-depth: 0

      - name: Install poetry
        uses: Gr1N/setup-poetry@v9

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: poetry

      - name: Install python dependencies
        run: |
          poetry config virtualenvs.in-project true
          poetry install --no-interaction

      - name: Prepare Environment (debug)
        run: |
          set -euo pipefail
          set -x

          # Where prepare-content will place artifacts (zips)
          mkdir -p "${GITHUB_WORKSPACE}/content/new_packs_zips"
          echo "NEW_PACKS_FOLDER=${GITHUB_WORKSPACE}/content/new_packs_zips" >> $GITHUB_ENV

          # Make sure default branch ref exists locally
          git fetch origin "${DEFAULT_BRANCH}" --prune

          echo "===== DEBUG: Branch/SHAs ====="
          echo "BRANCH_NAME=${BRANCH_NAME}"
          echo "DEFAULT_BRANCH=${DEFAULT_BRANCH}"
          echo "BEFORE_SHA=${BEFORE_SHA:-}"
          echo "GITHUB_SHA=${GITHUB_SHA:-}"

          # Decide diff range:
          # - On push: use BEFORE_SHA..GITHUB_SHA
          # - On workflow_dispatch: fallback to origin/DEFAULT_BRANCH...HEAD
          if [ -n "${BEFORE_SHA:-}" ] && [ "${BEFORE_SHA}" != "0000000000000000000000000000000000000000" ]; then
            RANGE="${BEFORE_SHA}..${GITHUB_SHA}"
          else
            RANGE="origin/${DEFAULT_BRANCH}...HEAD"
          fi

          echo "DEBUG: Using RANGE=${RANGE}"

          # Get changed packs from THIS repo (where your Packs/ folder lives)
          CHANGED_FILES="$(git diff --name-only ${RANGE} || true)"
          echo "DEBUG: Changed files:"
          echo "${CHANGED_FILES}" || true

          PACKS_CHANGED="$(echo "${CHANGED_FILES}" | awk -F/ '/^Packs\//{print $1"/"$2}' | sort -u | tr '\n' ' ' | xargs || true)"
          echo "PACKS_CHANGED=${PACKS_CHANGED}" >> $GITHUB_ENV
          echo "DEBUG: PACKS_CHANGED='${PACKS_CHANGED}'"

      - name: Prepare Venv
        run: |
          set -euo pipefail
          set -x
          cd "$GITHUB_WORKSPACE/content/"

          # Install node packages (fase mantenida)
          npm install .

          git config diff.renameLimit 6000
          echo "========== Build Parameters =========="
          python --version
          cd "$GITHUB_WORKSPACE"
          poetry run demisto-sdk --version
          echo "====================================="

      - name: Create Packs Artifacts (debug)
        run: |
          set -euo pipefail
          set -x

          echo "PACKS_CHANGED='${PACKS_CHANGED:-}'"
          echo "NEW_PACKS_FOLDER='${NEW_PACKS_FOLDER:-}'"

          if [ -n "${PACKS_CHANGED:-}" ]; then
            # prepare-content creates the zips in NEW_PACKS_FOLDER
            poetry run demisto-sdk prepare-content --input "$PACKS_CHANGED" --output "$NEW_PACKS_FOLDER"
            echo "Artifacts generated at: $NEW_PACKS_FOLDER"
            ls -la "$NEW_PACKS_FOLDER" || true
          else
            echo "No packs has changed, skipping step."
          fi

      - name: Install bucket upload deps
        run: |
          python -m pip install --upgrade pip prettytable google-cloud-storage

      - name: Upload Packs to XSOAR (debug)
        env:
          DEMISTO_BASE_URL: ${{ secrets.DEMISTO_BASE_URL }}
          DEMISTO_API_KEY: ${{ secrets.DEMISTO_API_KEY }}
          XSIAM_AUTH_ID: ${{ vars.XSIAM_AUTH_ID }}
        run: |
          set -euo pipefail
          set -x

          echo "===== DEBUG Upload ====="
          echo "BRANCH_NAME=${BRANCH_NAME}"
          echo "DEFAULT_BRANCH=${DEFAULT_BRANCH}"
          echo "PACKS_CHANGED='${PACKS_CHANGED:-}'"
          echo "NEW_PACKS_FOLDER='${NEW_PACKS_FOLDER:-}'"
          echo "DEMISTO_BASE_URL set? $([ -n "${DEMISTO_BASE_URL:-}" ] && echo yes || echo no)"
          echo "DEMISTO_API_KEY set? $([ -n "${DEMISTO_API_KEY:-}" ] && echo yes || echo no)"
          echo "XSIAM_AUTH_ID='${XSIAM_AUTH_ID:-}'"
          poetry run demisto-sdk --version || true

          if [ -n "${PACKS_CHANGED:-}" ]; then
            if [ "${BRANCH_NAME}" = "${DEFAULT_BRANCH}" ]; then
              echo "Uploading artifacts ${PACKS_CHANGED}."
              ls -la "$NEW_PACKS_FOLDER" || { echo "Folder not found: $NEW_PACKS_FOLDER"; exit 1; }

              echo "Artifacts to upload:"
              find "$NEW_PACKS_FOLDER" -maxdepth 1 -type f -print || true

              for pack in "$NEW_PACKS_FOLDER"/*; do
                [ -e "$pack" ] || { echo "No artifacts found to upload in $NEW_PACKS_FOLDER"; exit 0; }
                echo "Uploading: $pack"
                ls -lh "$pack" || true
                poetry run demisto-sdk upload --input "$pack"
              done
            else
              echo "The current branch is not the default branch, skipping upload to server."
            fi
          else
            echo "No packs has changed, skipping step."
          fi